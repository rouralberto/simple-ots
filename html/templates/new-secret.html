<div class="row">
    <div class="col-md-8 offset-md-2">
        <h1 class="text-center">Store new secret</h1>

        <form id="secret-form" method="post" action="/write/">
            <input type="hidden" name="csrf_token" value="{{CSRF_TOKEN}}">

            <div class="form-group my-5">
                <label for="expiry">Expiry</label>
                <select class="form-select" id="expiry" name="expiry">
                    <option value="3600">1 hour</option>
                    <option value="86400">1 day</option>
                    <option value="604800">1 week</option>
                </select>
            </div>
            <div class="form-group">
                <label for="secret">Secret</label>
                <textarea class="form-control" id="secret" name="secret" rows="3"></textarea>
            </div>

            <div class="text-center">
                <button type="submit" id="submit-btn" class="mt-5 btn btn-lg btn-outline-success">Create Secret</button>
            </div>

            <p class="text-center mt-3 small text-muted">
                <i class="bi bi-shield-lock me-1"></i>
                Your secret is encrypted in your browser before being sent. The server never sees the plaintext.
            </p>
        </form>
    </div>
</div>

<script>
(function() {
    const form = document.getElementById('secret-form');
    const secretInput = document.getElementById('secret');
    const submitBtn = document.getElementById('submit-btn');

    form.addEventListener('submit', async function(e) {
        e.preventDefault();

        if (!secretInput.value.trim()) {
            return;
        }

        submitBtn.disabled = true;
        submitBtn.innerHTML = 'Encrypting...';

        const key = await OTSCrypto.generateKey();
        const keyString = await OTSCrypto.exportKey(key);
        const encryptedData = await OTSCrypto.encrypt(secretInput.value, key);

        sessionStorage.setItem('ots_pending_key', keyString);
        secretInput.value = encryptedData;

        form.submit();
    });
})();
</script>
